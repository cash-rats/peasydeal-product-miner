services:
  worker:
    image: ghcr.io/${GHCR_USER}/peasydeal-product-miner:latest
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
    # RabbitMQ is provided by a managed cloud instance.
    network_mode: host
    environment:
      - HOME=/home/app

      - CHROME_DEBUG_HOST=${CHROME_DEBUG_HOST:-host.docker.internal}
      - CHROME_DEBUG_PORT=${CHROME_DEBUG_PORT:-9222}

      - CRAWL_TOOL=${CRAWL_TOOL:-codex}
      - CRAWL_SKILL_NAME=${CRAWL_SKILL_NAME:-}
      - CODEX_SKIP_GIT_REPO_CHECK=${CODEX_SKIP_GIT_REPO_CHECK:-1}
      - CODEX_MODEL=${CODEX_MODEL:-gpt-5.2}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.5-flash}

      - RABBITMQ_URL=${RABBITMQ_URL:-amqp://guest:guest@rabbitmq:5672/}
      - RABBITMQ_EXCHANGE=${RABBITMQ_EXCHANGE:-events}
      - RABBITMQ_QUEUE=${RABBITMQ_QUEUE:-crawler.url.requested.v1}
      - RABBITMQ_ROUTING_KEY=${RABBITMQ_ROUTING_KEY:-crawler.url.requested.v1}
      - RABBITMQ_PREFETCH=${RABBITMQ_PREFETCH:-1}
      - RABBITMQ_DECLARE_TOPOLOGY=${RABBITMQ_DECLARE_TOPOLOGY:-true}

      # For local dev, persist sqlite DB into the bind-mounted /out volume.
      - TURSO_SQLITE_PATH=${TURSO_SQLITE_PATH:-file:/out/turso.db}
      - TURSO_SQLITE_DSN=${TURSO_SQLITE_DSN:-}
      - TURSO_SQLITE_TOKEN=${TURSO_SQLITE_TOKEN:-}
      - TURSO_SQLITE_DRIVER=${TURSO_SQLITE_DRIVER:-sqlite}
    volumes:
      - ./out:/out
      - ./config:/app/config:ro
      - ./codex:/codex:rw
      - ./gemini:/gemini:rw
    command: ["/app/worker"]

  runner:
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
    environment:
      - HOME=/home/app
      - CODEX_SKIP_GIT_REPO_CHECK=${CODEX_SKIP_GIT_REPO_CHECK:-1}
      - CRAWL_TOOL=${CRAWL_TOOL:-codex}
      - CRAWL_SKILL_NAME=${CRAWL_SKILL_NAME:-}
      - CHROME_DEBUG_HOST=${CHROME_DEBUG_HOST:-host.docker.internal}
      - CHROME_DEBUG_PORT=${CHROME_DEBUG_PORT:-9222}
      - CODEX_MODEL=${CODEX_MODEL:-gpt-5.2}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.5-flash}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    stdin_open: true
    tty: true
    volumes:
      - ./out:/out
      - ./config:/app/config:ro
      - ./codex:/codex:rw
      - ./gemini:/gemini:rw
    # Template: run a single URL (set TARGET_URL in `.env`).
    command: >
      sh -lc
      '/app/devtool once
      --url "$$TARGET_URL"
      --tool "$$CRAWL_TOOL"
      --out-dir /out'
